<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Cash Town + Cucurbit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { background: #0f0f23; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; }
        .card { background: #1a1a2e; border-radius: 12px; border: 1px solid #2a2a4a; }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .tab { cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; }
        .tab.active { background: #2a2a4a; }
        .tab:hover { background: #252540; }
        .scrollable { max-height: 400px; overflow-y: auto; }
        .tf-btn { transition: all 0.2s; }
        .tf-btn:hover { background: #3b82f6; }
        .chart-container { position: relative; }
        .btn { padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #22c55e; color: white; }
        .btn-success:hover { background: #16a34a; }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold">üí∞ Cash Town + Cucurbit</h1>
                <p class="text-gray-400 text-sm" id="status">Loading...</p>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-success text-sm" onclick="startTrading()">‚ñ∂ Start</button>
                <button class="btn btn-danger text-sm" onclick="stopTrading()">‚èπ Stop</button>
                <button class="btn btn-primary text-sm" onclick="syncPositions()">üîÑ Sync</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4 border-b border-gray-700 pb-2">
            <div class="tab active" onclick="showTab('overview')" id="tab-overview">üìä Overview</div>
            <div class="tab" onclick="showTab('charts')" id="tab-charts">üìà Charts</div>
            <div class="tab" onclick="showTab('positions')" id="tab-positions">üíº Positions</div>
            <div class="tab" onclick="showTab('trades')" id="tab-trades">üìú Trades</div>
            <div class="tab" onclick="showTab('risk')" id="tab-risk">‚ö†Ô∏è Risk</div>
            <div class="tab" onclick="showTab('strategies')" id="tab-strategies">üéØ Strategies</div>
        </div>

        <!-- Overview Tab -->
        <div id="panel-overview">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
                <div class="card p-4">
                    <div class="text-gray-400 text-xs">Total PnL (All Time)</div>
                    <div id="total-pnl" class="text-2xl font-bold">$0.00</div>
                </div>
                <div class="card p-4">
                    <div class="text-gray-400 text-xs">Today's PnL</div>
                    <div id="daily-pnl" class="text-xl font-bold">$0.00</div>
                </div>
                <div class="card p-4">
                    <div class="text-gray-400 text-xs">Open Positions</div>
                    <div id="open-positions" class="text-xl font-bold">0</div>
                </div>
                <div class="card p-4">
                    <div class="text-gray-400 text-xs">Win Rate</div>
                    <div id="win-rate" class="text-xl font-bold">0%</div>
                </div>
                <div class="card p-4">
                    <div class="text-gray-400 text-xs">Total Trades</div>
                    <div id="total-trades" class="text-xl font-bold">0</div>
                </div>
                <div class="card p-4">
                    <div class="text-gray-400 text-xs">Balance</div>
                    <div id="balance" class="text-xl font-bold">$0.00</div>
                </div>
            </div>

            <!-- Chart + Strategy Stats -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="card p-4">
                    <h3 class="font-bold mb-2">üìà PnL Chart</h3>
                    <canvas id="pnl-chart" height="150"></canvas>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold mb-2">üéØ Strategy Performance</h3>
                    <div id="strategy-stats" class="space-y-2 scrollable"></div>
                </div>
            </div>

            <!-- Positions by Bot -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4">
                    <h3 class="font-bold mb-2">ü§ñ Cucurbit Positions</h3>
                    <div id="positions-cucurbit" class="overflow-x-auto"></div>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold mb-2">üí∞ Cash Town Positions</h3>
                    <div id="positions-cashtown" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="panel-charts" class="hidden">
            <!-- Chart Controls -->
            <div class="card p-4 mb-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="text-xs text-gray-400">Symbol</label>
                        <select id="chart-symbol" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm ml-2" onchange="loadChart()">
                            <option value="BTC/USDT:USDT">BTC/USDT</option>
                            <option value="ETH/USDT:USDT">ETH/USDT</option>
                            <option value="SOL/USDT:USDT">SOL/USDT</option>
                            <option value="XRP/USDT:USDT">XRP/USDT</option>
                            <option value="DOGE/USDT:USDT">DOGE/USDT</option>
                            <option value="BNB/USDT:USDT">BNB/USDT</option>
                            <option value="ADA/USDT:USDT">ADA/USDT</option>
                            <option value="AVAX/USDT:USDT">AVAX/USDT</option>
                            <option value="LINK/USDT:USDT">LINK/USDT</option>
                            <option value="MATIC/USDT:USDT">MATIC/USDT</option>
                            <option value="ARB/USDT:USDT">ARB/USDT</option>
                            <option value="OP/USDT:USDT">OP/USDT</option>
                            <option value="PEPE/USDT:USDT">PEPE/USDT</option>
                            <option value="WIF/USDT:USDT">WIF/USDT</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Timeframe</label>
                        <div class="inline-flex gap-1 ml-2">
                            <button class="tf-btn px-3 py-1 rounded bg-gray-700 text-xs" data-tf="1m">1m</button>
                            <button class="tf-btn px-3 py-1 rounded bg-gray-700 text-xs" data-tf="5m">5m</button>
                            <button class="tf-btn px-3 py-1 rounded bg-blue-600 text-xs" data-tf="15m">15m</button>
                            <button class="tf-btn px-3 py-1 rounded bg-gray-700 text-xs" data-tf="1h">1h</button>
                            <button class="tf-btn px-3 py-1 rounded bg-gray-700 text-xs" data-tf="4h">4h</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Indicators</label>
                        <div class="inline-flex gap-2 ml-2">
                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                <input type="checkbox" id="show-rsi" onchange="toggleIndicator('rsi')"> RSI
                            </label>
                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                <input type="checkbox" id="show-ma" checked onchange="toggleIndicator('ma')"> MA
                            </label>
                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                <input type="checkbox" id="show-volume" checked onchange="toggleIndicator('volume')"> Vol
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="flex items-center gap-1 text-xs cursor-pointer">
                            <input type="checkbox" id="show-trades" checked onchange="toggleTrades()"> 
                            <span class="text-gray-400">Show Trades</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Main Chart Container -->
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold" id="chart-title">üìà BTC/USDT - 15m</h3>
                    <div class="text-xs text-gray-400" id="chart-status">Loading...</div>
                </div>
                <div id="main-chart" style="height: 400px;"></div>
            </div>
            
            <!-- RSI Chart (optional) -->
            <div id="rsi-container" class="card p-4 mb-4 hidden">
                <h3 class="font-bold mb-2 text-sm">RSI (14)</h3>
                <div id="rsi-chart" style="height: 120px;"></div>
            </div>
            
            <!-- Trade Analysis Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card p-4">
                    <h3 class="font-bold mb-2">üìä Trade Analysis</h3>
                    <p class="text-gray-400 text-xs mb-3">Click a trade marker on the chart or select from list</p>
                    <div id="trade-list" class="space-y-2 scrollable max-h-64"></div>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold mb-2">üîç Trade Detail</h3>
                    <div id="trade-detail" class="text-gray-400 text-sm">
                        <p>Select a trade to view detailed analysis</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Positions Tab -->
        <div id="panel-positions" class="hidden">
            <div class="card p-4 mb-4">
                <h3 class="font-bold mb-3">Open Position</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                    <input type="text" id="new-symbol" placeholder="BTC/USDT" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <select id="new-side" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                        <option value="long">Long</option>
                        <option value="short">Short</option>
                    </select>
                    <input type="number" id="new-size" placeholder="Size USD" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <input type="number" id="new-sl" placeholder="Stop Loss %" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <button class="btn btn-primary text-sm" onclick="openPosition()">Open</button>
                </div>
            </div>
            <div class="card p-4">
                <h3 class="font-bold mb-2">All Positions</h3>
                <div id="positions-full" class="overflow-x-auto scrollable"></div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="panel-trades" class="hidden">
            <div class="card p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold">Trade History</h3>
                    <button class="btn btn-primary text-sm" onclick="downloadCSV()">üì• Download CSV</button>
                </div>
                <div id="trades-table" class="overflow-x-auto scrollable"></div>
            </div>
        </div>

        <!-- Risk Tab -->
        <div id="panel-risk" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card p-4">
                    <h3 class="font-bold mb-3">Risk Profile</h3>
                    <div id="risk-profile" class="space-y-2"></div>
                    <div class="mt-4">
                        <label class="text-sm text-gray-400">Change Profile:</label>
                        <select id="profile-select" class="bg-gray-800 border border-gray-700 rounded p-2 text-sm w-full mt-1" onchange="changeProfile()">
                        </select>
                    </div>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold mb-3">Risk State</h3>
                    <div id="risk-state" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Strategies Tab -->
        <div id="panel-strategies" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card p-4">
                    <h3 class="font-bold mb-3">Strategy Weights</h3>
                    <div id="strategy-weights" class="space-y-2"></div>
                    <button class="btn btn-danger text-sm mt-4" onclick="clearWeights()">Clear All Weights</button>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold mb-3">Recent Signals</h3>
                    <div id="signals-list" class="space-y-2 scrollable"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = new URLSearchParams(window.location.search).get('api') 
            || (window.location.hostname === 'localhost' ? 'http://localhost:8888' : 'https://web-production-63664b.up.railway.app');
        
        // API Key for authentication
        let API_KEY = new URLSearchParams(window.location.search).get('key') 
            || localStorage.getItem('cash_town_api_key') || '';
        
        // Prompt for API key if not set and not localhost
        if (!API_KEY && window.location.hostname !== 'localhost') {
            API_KEY = prompt('Enter Cash Town API Key:') || '';
            if (API_KEY) localStorage.setItem('cash_town_api_key', API_KEY);
        }
        
        // Helper for authenticated fetch
        function authFetch(url, options = {}) {
            const headers = options.headers || {};
            if (API_KEY) {
                headers['Authorization'] = `Bearer ${API_KEY}`;
            }
            return fetch(url, { ...options, headers });
        }
        
        let pnlChart = null;
        let currentTab = 'overview';

        // Tab switching
        function showTab(tab) {
            document.querySelectorAll('[id^="panel-"]').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            currentTab = tab;
            refresh();
        }

        // Trading controls
        async function startTrading() {
            if (!confirm('Start trading?')) return;
            try {
                await authFetch(`${API}/cucurbit/trading/start`, {method: 'POST'});
                showToast('Trading started');
                refresh();
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        async function stopTrading() {
            if (!confirm('Stop trading?')) return;
            try {
                await authFetch(`${API}/cucurbit/trading/stop`, {method: 'POST'});
                showToast('Trading stopped');
                refresh();
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        async function syncPositions() {
            try {
                await authFetch(`${API}/cucurbit/sync-positions`, {method: 'POST'});
                showToast('Positions synced');
                refresh();
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        // Position management
        async function openPosition() {
            const symbol = document.getElementById('new-symbol').value;
            const side = document.getElementById('new-side').value;
            const sizeUsd = parseFloat(document.getElementById('new-size').value);
            const stopLoss = parseFloat(document.getElementById('new-sl').value) || undefined;
            
            if (!symbol || !sizeUsd) { showToast('Fill in symbol and size', true); return; }
            
            try {
                const resp = await authFetch(`${API}/cucurbit/positions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol, side, sizeUsd, stopLoss})
                });
                const data = await resp.json();
                if (data.success) {
                    showToast('Position opened');
                    refresh();
                } else {
                    showToast('Error: ' + data.error, true);
                }
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        async function closePosition(id) {
            if (!confirm('Close this position?')) return;
            try {
                const resp = await authFetch(`${API}/cucurbit/positions/${id}`, {method: 'DELETE'});
                const data = await resp.json();
                showToast(data.success ? 'Position closed' : 'Error: ' + data.error, !data.success);
                refresh();
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        // Risk management
        async function changeProfile() {
            const profile = document.getElementById('profile-select').value;
            try {
                await authFetch(`${API}/cucurbit/risk-profile`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({profile})
                });
                showToast('Profile changed to ' + profile);
                refresh();
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        async function clearWeights() {
            if (!confirm('Clear all strategy weights?')) return;
            try {
                await authFetch(`${API}/cucurbit/weights`, {method: 'DELETE'});
                showToast('Weights cleared');
                refresh();
            } catch (e) { showToast('Error: ' + e.message, true); }
        }

        function downloadCSV() {
            window.open(`${API}/cucurbit/trades/csv`, '_blank');
        }

        // Data fetching
        async function refresh() {
            try {
                // Fetch Cucurbit health data
                const healthRes = await authFetch(`${API}/cucurbit`);
                const health = await healthRes.json();
                updateHealth(health);

                // Fetch Cucurbit positions (proxied)
                const posRes = await authFetch(`${API}/cucurbit/positions`);
                const posData = await posRes.json();
                
                // Fetch Cash Town live positions directly from KuCoin
                let cashTownLive = [];
                try {
                    const ctRes = await authFetch(`${API}/positions/live`);
                    const ctData = await ctRes.json();
                    cashTownLive = (ctData.positions || []).map(p => ({
                        ...p,
                        strategyId: 'cash-town-live',
                        isCashTown: true
                    }));
                } catch (e) { console.warn('Could not fetch Cash Town live positions:', e); }
                
                // Combine positions
                const allPositions = [...(posData.positions || []), ...cashTownLive];
                updatePositions(allPositions);

                // Fetch trades
                const tradesRes = await authFetch(`${API}/cucurbit/trades`);
                const tradesData = await tradesRes.json();
                updateTrades(tradesData);

                // Fetch risk profile
                const riskRes = await authFetch(`${API}/cucurbit/risk-profile`);
                const riskData = await riskRes.json();
                updateRisk(riskData);

                // Fetch signals
                const sigRes = await authFetch(`${API}/cucurbit/signals?limit=20`);
                const sigData = await sigRes.json();
                updateSignals(sigData.signals || []);

                // Fetch weights
                const weightsRes = await authFetch(`${API}/cucurbit/weights`);
                const weightsData = await weightsRes.json();
                updateWeights(weightsData.weights || {});

                // Fetch balances
                const balRes = await authFetch(`${API}/cucurbit/balances`);
                const balData = await balRes.json();
                if (balData.balances) {
                    const equity = balData.balances.USDT_EQUITY || balData.balances.accountEquity || 0;
                    document.getElementById('balance').textContent = `$${equity.toFixed(2)}`;
                }

                document.getElementById('status').textContent = `üü¢ Connected ‚Ä¢ Updated ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.error('Refresh error:', e);
                document.getElementById('status').textContent = 'üî¥ Connection error';
            }
        }

        function updateHealth(data) {
            const trading = data.trading || {};
            const strategies = trading.strategyMetrics || [];
            
            document.getElementById('open-positions').textContent = trading.total_positions || 0;
            
            let totalPnl = 0, totalTrades = 0, wins = 0;
            strategies.forEach(s => {
                totalPnl += s.totalPnl || 0;
                totalTrades += s.totalTrades || 0;
                wins += s.winningTrades || 0;
            });
            
            document.getElementById('total-pnl').textContent = `$${totalPnl.toFixed(2)}`;
            document.getElementById('total-pnl').className = `text-xl font-bold ${totalPnl >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('total-trades').textContent = totalTrades;
            document.getElementById('win-rate').textContent = totalTrades > 0 ? `${(wins/totalTrades*100).toFixed(1)}%` : '0%';
            
            // Strategy stats
            const statsHtml = strategies.map(s => `
                <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded">
                    <div>
                        <span class="${s.status === 'active' ? 'text-green-400' : 'text-red-400'}">‚óè</span>
                        <span class="ml-2">${s.name}</span>
                    </div>
                    <div class="text-right">
                        <span class="${s.totalPnl >= 0 ? 'positive' : 'negative'}">$${(s.totalPnl || 0).toFixed(2)}</span>
                        <span class="text-gray-400 text-xs ml-2">${s.totalTrades || 0} trades</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('strategy-stats').innerHTML = statsHtml || '<div class="text-gray-500">No strategy data</div>';
        }

        function updatePositions(positions) {
            // Separate positions by bot (Cash Town strategies vs Cucurbit strategies)
            const cashTownStrategies = ['cash_town', 'momentum', 'scalp', 'cash-town-live'];
            const isCashTown = (p) => p.isCashTown || cashTownStrategies.includes(p.strategyId?.toLowerCase());
            const cucurbitPositions = positions.filter(p => !isCashTown(p));
            const cashTownPositions = positions.filter(p => isCashTown(p));
            
            const makeTable = (posArr) => posArr.length ? `
                <table class="w-full text-sm">
                    <thead><tr class="text-gray-400 text-left">
                        <th class="pb-2">Symbol</th><th>Side</th><th>Size</th><th>Entry</th><th>PnL</th><th>Strategy</th><th></th>
                    </tr></thead>
                    <tbody>${posArr.map(p => {
                        const entry = p.entryPrice || p.entry_price || 0;
                        const pnl = p.unrealizedPnl || p.unrealized_pnl || 0;
                        const size = p.size || 0;
                        return `
                        <tr class="border-t border-gray-700/50">
                            <td class="py-2 font-medium">${p.symbol}</td>
                            <td class="${p.side === 'long' ? 'positive' : 'negative'}">${p.side?.toUpperCase()}</td>
                            <td>${size}</td>
                            <td>$${entry.toFixed(4)}</td>
                            <td class="${pnl >= 0 ? 'positive' : 'negative'}">$${pnl.toFixed(2)}</td>
                            <td class="text-gray-400">${p.strategyId || 'live'}</td>
                            <td>${p.id ? `<button class="text-red-400 hover:text-red-300" onclick="closePosition('${p.id}')">‚úï</button>` : ''}</td>
                        </tr>
                    `}).join('')}</tbody>
                </table>
            ` : '<div class="text-gray-500 py-4 text-center">No open positions</div>';
            
            document.getElementById('positions-cucurbit').innerHTML = makeTable(cucurbitPositions);
            document.getElementById('positions-cashtown').innerHTML = makeTable(cashTownPositions);
            document.getElementById('positions-full').innerHTML = makeTable(positions);
        }

        function updateTrades(data) {
            const trades = data.trades || [];
            const summary = data.summary || {};
            const chartData = data.chartData || [];
            
            // Update Total PnL from summary (all time)
            if (summary.totalPnl !== undefined) {
                document.getElementById('total-pnl').textContent = `$${summary.totalPnl.toFixed(2)}`;
                document.getElementById('total-pnl').className = `text-2xl font-bold ${summary.totalPnl >= 0 ? 'positive' : 'negative'}`;
            }
            
            // Update Daily PnL
            if (summary.dailyPnl !== undefined) {
                document.getElementById('daily-pnl').textContent = `$${summary.dailyPnl.toFixed(2)}`;
                document.getElementById('daily-pnl').className = `text-xl font-bold ${summary.dailyPnl >= 0 ? 'positive' : 'negative'}`;
            }
            
            // Update chart
            const ctx = document.getElementById('pnl-chart').getContext('2d');
            if (pnlChart) pnlChart.destroy();
            
            if (chartData.length > 0) {
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.map(d => new Date(d.timestamp * 1000).toLocaleDateString()),
                        datasets: [{
                            label: 'Cumulative PnL',
                            data: chartData.map(d => d.pnl),
                            borderColor: chartData[chartData.length-1]?.pnl >= 0 ? '#22c55e' : '#ef4444',
                            tension: 0.3,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {legend: {display: false}},
                        scales: {
                            y: {grid: {color: '#2a2a4a'}, ticks: {color: '#888'}},
                            x: {grid: {color: '#2a2a4a'}, ticks: {color: '#888', maxRotation: 45}}
                        }
                    }
                });
            } else {
                // Build chart from trades if no chartData
                if (trades.length > 0) {
                    let cumPnl = 0;
                    const sortedTrades = [...trades].sort((a,b) => new Date(a.exitTimestamp) - new Date(b.exitTimestamp));
                    const cumData = sortedTrades.map(t => {
                        cumPnl += (t.pnl || 0);
                        return { date: new Date(t.exitTimestamp).toLocaleDateString(), pnl: cumPnl };
                    });
                    
                    pnlChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: cumData.map(d => d.date),
                            datasets: [{
                                label: 'Cumulative PnL',
                                data: cumData.map(d => d.pnl),
                                borderColor: cumPnl >= 0 ? '#22c55e' : '#ef4444',
                                tension: 0.3,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {legend: {display: false}},
                            scales: {
                                y: {grid: {color: '#2a2a4a'}, ticks: {color: '#888'}},
                                x: {grid: {color: '#2a2a4a'}, ticks: {color: '#888', maxRotation: 45}}
                            }
                        }
                    });
                } else {
                    // Show placeholder
                    ctx.fillStyle = '#666';
                    ctx.font = '14px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No trade data for chart', ctx.canvas.width/2, ctx.canvas.height/2);
                }
            }
            
            // Trades table
            const tradesHtml = trades.length ? `
                <table class="w-full text-sm">
                    <thead><tr class="text-gray-400 text-left">
                        <th class="pb-2">Time</th><th>Symbol</th><th>Side</th><th>Strategy</th><th>Entry</th><th>Exit</th><th>PnL</th>
                    </tr></thead>
                    <tbody>${trades.slice(0, 50).map(t => `
                        <tr class="border-t border-gray-700/50">
                            <td class="py-2 text-xs text-gray-400">${new Date(t.exitTimestamp).toLocaleString()}</td>
                            <td class="font-medium">${t.symbol}</td>
                            <td class="${t.side === 'long' ? 'positive' : 'negative'}">${t.side?.toUpperCase()}</td>
                            <td class="text-gray-400">${t.strategyId || '?'}</td>
                            <td>$${t.entryPrice?.toFixed(4) || '?'}</td>
                            <td>$${t.exitPrice?.toFixed(4) || '?'}</td>
                            <td class="${(t.pnl || 0) >= 0 ? 'positive' : 'negative'}">$${(t.pnl || 0).toFixed(2)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<div class="text-gray-500 py-4 text-center">No trades yet</div>';
            document.getElementById('trades-table').innerHTML = tradesHtml;
        }

        function updateRisk(data) {
            const profileHtml = `
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">Current Profile:</span><span class="font-bold">${data.currentProfile || '?'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Max Position:</span><span>${data.settings?.maxPositionSize || '?'}%</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Max Exposure:</span><span>${data.settings?.maxTotalExposure || '?'}%</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Daily Loss Limit:</span><span>${data.limits?.dailyLossLimit || '?'}%</span></div>
                </div>
            `;
            document.getElementById('risk-profile').innerHTML = profileHtml;
            
            const profiles = data.availableProfiles || [];
            document.getElementById('profile-select').innerHTML = profiles.map(p => 
                `<option value="${p}" ${p === data.currentProfile ? 'selected' : ''}>${p}</option>`
            ).join('');
            
            // Update daily PnL from risk state if not already set
            const dailyPnlEl = document.getElementById('daily-pnl');
            if (dailyPnlEl.textContent === '$0.00' && data.riskState?.dailyPnl !== undefined) {
                dailyPnlEl.textContent = `$${data.riskState.dailyPnl.toFixed(2)}`;
                dailyPnlEl.className = `text-xl font-bold ${data.riskState.dailyPnl >= 0 ? 'positive' : 'negative'}`;
            }
            
            const stateHtml = `
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between"><span class="text-gray-400">Can Trade:</span><span class="${data.riskState?.canTrade ? 'positive' : 'negative'}">${data.riskState?.canTrade ? 'Yes' : 'No'}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Daily PnL:</span><span class="${(data.riskState?.dailyPnl || 0) >= 0 ? 'positive' : 'negative'}">$${(data.riskState?.dailyPnl || 0).toFixed(2)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Open Positions:</span><span>${data.riskState?.openPositionCount || 0}</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Total Exposure:</span><span>${(data.riskState?.totalExposure || 0).toFixed(1)}%</span></div>
                </div>
            `;
            document.getElementById('risk-state').innerHTML = stateHtml;
        }

        function updateSignals(signals) {
            const html = signals.length ? signals.map(s => `
                <div class="p-2 bg-gray-800/50 rounded text-sm">
                    <div class="flex justify-between">
                        <span class="font-medium">${s.symbol}</span>
                        <span class="${s.side === 'long' ? 'positive' : 'negative'}">${s.side?.toUpperCase()}</span>
                    </div>
                    <div class="text-xs text-gray-400">${s.strategyId} ‚Ä¢ ${new Date(s.timestamp).toLocaleString()}</div>
                </div>
            `).join('') : '<div class="text-gray-500">No recent signals</div>';
            document.getElementById('signals-list').innerHTML = html;
        }

        function updateWeights(weights) {
            const entries = Object.entries(weights);
            const html = entries.length ? entries.map(([k, v]) => `
                <div class="flex justify-between p-2 bg-gray-800/50 rounded">
                    <span>${k}</span><span>${v}</span>
                </div>
            `).join('') : '<div class="text-gray-500">No active weights</div>';
            document.getElementById('strategy-weights').innerHTML = html;
        }

        function showToast(msg, isError = false) {
            alert(msg); // Simple alert for now
        }

        // Initial load
        refresh();
        setInterval(refresh, 30000);

        // ============================================
        // TRADINGVIEW LIGHTWEIGHT CHARTS - TRADE VIZ
        // ============================================
        
        let mainChart = null;
        let candleSeries = null;
        let volumeSeries = null;
        let rsiChart = null;
        let rsiSeries = null;
        let ma20Series = null;
        let ma50Series = null;
        let tradeMarkers = [];
        let slLines = [];
        let tpLines = [];
        let allTrades = [];
        let currentSymbol = 'BTC/USDT:USDT';
        let currentTimeframe = '15m';
        
        // Initialize chart when Charts tab is opened
        function initMainChart() {
            if (mainChart) return; // Already initialized
            
            const container = document.getElementById('main-chart');
            mainChart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#1a1a2e' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#2a2a4a' },
                    horzLines: { color: '#2a2a4a' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2a2a4a',
                },
                timeScale: {
                    borderColor: '#2a2a4a',
                    timeVisible: true,
                    secondsVisible: false,
                },
                handleScroll: true,
                handleScale: true,
            });
            
            // Candlestick series
            candleSeries = mainChart.addCandlestickSeries({
                upColor: '#22c55e',
                downColor: '#ef4444',
                borderUpColor: '#22c55e',
                borderDownColor: '#ef4444',
                wickUpColor: '#22c55e',
                wickDownColor: '#ef4444',
            });
            
            // Volume series
            volumeSeries = mainChart.addHistogramSeries({
                color: '#3b82f6',
                priceFormat: { type: 'volume' },
                priceScaleId: '',
                scaleMargins: { top: 0.85, bottom: 0 },
            });
            
            // Moving Averages
            ma20Series = mainChart.addLineSeries({
                color: '#f59e0b',
                lineWidth: 1,
                title: 'MA20',
            });
            
            ma50Series = mainChart.addLineSeries({
                color: '#8b5cf6',
                lineWidth: 1,
                title: 'MA50',
            });
            
            // Fit content
            mainChart.timeScale().fitContent();
            
            // Handle resize
            const resizeObserver = new ResizeObserver(() => {
                if (mainChart) {
                    mainChart.applyOptions({ width: container.clientWidth });
                }
            });
            resizeObserver.observe(container);
        }
        
        function initRsiChart() {
            if (rsiChart) return;
            
            const container = document.getElementById('rsi-chart');
            rsiChart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#1a1a2e' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#2a2a4a' },
                    horzLines: { color: '#2a2a4a' },
                },
                rightPriceScale: {
                    borderColor: '#2a2a4a',
                    scaleMargins: { top: 0.1, bottom: 0.1 },
                },
                timeScale: {
                    borderColor: '#2a2a4a',
                    visible: false,
                },
            });
            
            rsiSeries = rsiChart.addLineSeries({
                color: '#f59e0b',
                lineWidth: 2,
            });
            
            // Add overbought/oversold lines
            rsiChart.addLineSeries({
                color: '#ef4444',
                lineWidth: 1,
                lineStyle: 2, // Dashed
            });
        }
        
        // Fetch candle data from API with fallback to Binance
        async function fetchCandles(symbol, timeframe, limit = 300) {
            // Try Cash Town API first
            try {
                const url = `${API}/market/candles?symbol=${encodeURIComponent(symbol)}&timeframe=${timeframe}&limit=${limit}`;
                const resp = await authFetch(url);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.candles && data.candles.length > 0) {
                        return data.candles;
                    }
                }
            } catch (e) {
                console.warn('Cash Town API candles not available, using Binance fallback');
            }
            
            // Fallback to Binance API (free, no auth)
            try {
                const binanceSymbol = symbol.replace('/', '').replace(':USDT', '');
                const intervalMap = { '1m': '1m', '5m': '5m', '15m': '15m', '1h': '1h', '4h': '4h' };
                const interval = intervalMap[timeframe] || '15m';
                const url = `https://api.binance.com/api/v3/klines?symbol=${binanceSymbol}&interval=${interval}&limit=${limit}`;
                const resp = await fetch(url);
                const data = await resp.json();
                
                // Transform Binance format to our format
                return data.map(k => ({
                    timestamp: k[0],
                    open: parseFloat(k[1]),
                    high: parseFloat(k[2]),
                    low: parseFloat(k[3]),
                    close: parseFloat(k[4]),
                    volume: parseFloat(k[5]),
                }));
            } catch (e) {
                console.error('Failed to fetch candles from Binance:', e);
                return [];
            }
        }
        
        // Fetch trades for chart overlay
        async function fetchTradesForChart(symbol = null) {
            try {
                const url = symbol 
                    ? `${API}/cucurbit/trades?symbol=${encodeURIComponent(symbol)}&limit=100`
                    : `${API}/cucurbit/trades?limit=100`;
                const resp = await authFetch(url);
                const data = await resp.json();
                return data.trades || [];
            } catch (e) {
                console.error('Failed to fetch trades:', e);
                return [];
            }
        }
        
        // Load chart with data
        async function loadChart() {
            const symbol = document.getElementById('chart-symbol').value;
            currentSymbol = symbol;
            
            document.getElementById('chart-status').textContent = 'Loading...';
            document.getElementById('chart-title').textContent = `üìà ${symbol.split(':')[0]} - ${currentTimeframe}`;
            
            initMainChart();
            
            // Fetch candle data
            const candles = await fetchCandles(symbol, currentTimeframe);
            
            if (candles.length === 0) {
                document.getElementById('chart-status').textContent = 'No data available';
                return;
            }
            
            // Format data for LightweightCharts
            const ohlcData = candles.map(c => ({
                time: Math.floor(c.timestamp / 1000),
                open: c.open,
                high: c.high,
                low: c.low,
                close: c.close,
            }));
            
            const volumeData = candles.map(c => ({
                time: Math.floor(c.timestamp / 1000),
                value: c.volume,
                color: c.close >= c.open ? '#22c55e40' : '#ef444440',
            }));
            
            // Calculate MAs
            const ma20Data = calculateMA(ohlcData, 20);
            const ma50Data = calculateMA(ohlcData, 50);
            
            // Set data
            candleSeries.setData(ohlcData);
            volumeSeries.setData(volumeData);
            ma20Series.setData(ma20Data);
            ma50Series.setData(ma50Data);
            
            // Update RSI if enabled
            if (document.getElementById('show-rsi').checked) {
                updateRsiChart(ohlcData);
            }
            
            // Load and overlay trades
            if (document.getElementById('show-trades').checked) {
                await loadTradeMarkers(symbol);
            }
            
            mainChart.timeScale().fitContent();
            document.getElementById('chart-status').textContent = `${candles.length} candles loaded`;
        }
        
        // Calculate Moving Average
        function calculateMA(data, period) {
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                result.push({
                    time: data[i].time,
                    value: sum / period,
                });
            }
            return result;
        }
        
        // Calculate RSI
        function calculateRSI(data, period = 14) {
            const result = [];
            const gains = [];
            const losses = [];
            
            for (let i = 1; i < data.length; i++) {
                const change = data[i].close - data[i-1].close;
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
            }
            
            for (let i = period; i < gains.length; i++) {
                const avgGain = gains.slice(i - period, i).reduce((a,b) => a+b, 0) / period;
                const avgLoss = losses.slice(i - period, i).reduce((a,b) => a+b, 0) / period;
                const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
                const rsi = 100 - (100 / (1 + rs));
                result.push({
                    time: data[i + 1].time,
                    value: rsi,
                });
            }
            return result;
        }
        
        // Update RSI chart
        function updateRsiChart(ohlcData) {
            initRsiChart();
            const rsiData = calculateRSI(ohlcData);
            rsiSeries.setData(rsiData);
            
            // Sync time scales
            mainChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (rsiChart && range) {
                    rsiChart.timeScale().setVisibleLogicalRange(range);
                }
            });
        }
        
        // Load trade markers on chart
        async function loadTradeMarkers(symbol) {
            // Get trades
            const trades = await fetchTradesForChart();
            allTrades = trades;
            
            // Filter trades for this symbol
            const symbolTrades = trades.filter(t => {
                const tradeSymbol = t.symbol?.replace('/', '').replace(':USDT', '');
                const chartSymbol = symbol.replace('/', '').replace(':USDT', '');
                return tradeSymbol === chartSymbol || !symbol;
            });
            
            // Create markers
            const markers = [];
            
            symbolTrades.forEach((trade, idx) => {
                const entryTime = Math.floor(new Date(trade.entryTimestamp || trade.openTime).getTime() / 1000);
                const exitTime = Math.floor(new Date(trade.exitTimestamp || trade.closeTime).getTime() / 1000);
                const isLong = trade.side === 'long';
                const isWin = (trade.pnl || 0) >= 0;
                
                // Entry marker
                markers.push({
                    time: entryTime,
                    position: isLong ? 'belowBar' : 'aboveBar',
                    color: isLong ? '#22c55e' : '#ef4444',
                    shape: isLong ? 'arrowUp' : 'arrowDown',
                    text: `${isLong ? 'L' : 'S'} $${trade.entryPrice?.toFixed(2) || '?'}`,
                    id: `entry-${idx}`,
                });
                
                // Exit marker
                if (exitTime && exitTime > entryTime) {
                    markers.push({
                        time: exitTime,
                        position: isLong ? 'aboveBar' : 'belowBar',
                        color: isWin ? '#22c55e' : '#ef4444',
                        shape: 'circle',
                        text: `${isWin ? '‚úì' : '‚úó'} $${(trade.pnl || 0).toFixed(2)}`,
                        id: `exit-${idx}`,
                    });
                }
            });
            
            // Sort markers by time
            markers.sort((a, b) => a.time - b.time);
            candleSeries.setMarkers(markers);
            tradeMarkers = markers;
            
            // Update trade list
            updateTradeList(symbolTrades);
        }
        
        // Update trade list in sidebar
        function updateTradeList(trades) {
            const container = document.getElementById('trade-list');
            if (trades.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm">No trades for this symbol</div>';
                return;
            }
            
            const html = trades.slice(0, 20).map((t, idx) => {
                const pnl = t.pnl || 0;
                const isWin = pnl >= 0;
                return `
                    <div class="p-2 bg-gray-800/50 rounded cursor-pointer hover:bg-gray-700/50 transition" onclick="showTradeDetail(${idx})">
                        <div class="flex justify-between">
                            <span class="font-medium ${t.side === 'long' ? 'text-green-400' : 'text-red-400'}">
                                ${t.side?.toUpperCase()} ${t.symbol?.split('/')[0] || '?'}
                            </span>
                            <span class="${isWin ? 'positive' : 'negative'}">$${pnl.toFixed(2)}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            ${t.strategyId || '?'} ‚Ä¢ ${new Date(t.exitTimestamp || t.closeTime).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }
        
        // Show trade detail
        function showTradeDetail(idx) {
            const trades = allTrades;
            const t = trades[idx];
            if (!t) return;
            
            const entryTime = new Date(t.entryTimestamp || t.openTime);
            const exitTime = new Date(t.exitTimestamp || t.closeTime);
            const duration = (exitTime - entryTime) / 1000 / 60; // minutes
            const pnl = t.pnl || 0;
            const pnlPercent = t.entryPrice ? ((t.exitPrice - t.entryPrice) / t.entryPrice * 100 * (t.side === 'long' ? 1 : -1)).toFixed(2) : '?';
            
            // Determine exit reason
            let exitReason = 'Unknown';
            if (t.exitReason) {
                exitReason = t.exitReason;
            } else if (t.stopLoss && t.exitPrice <= t.stopLoss) {
                exitReason = 'üõë Hit Stop Loss';
            } else if (t.takeProfit && t.exitPrice >= t.takeProfit) {
                exitReason = 'üéØ Hit Take Profit';
            } else {
                exitReason = '‚úã Manual Close / Strategy Exit';
            }
            
            const html = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold ${t.side === 'long' ? 'text-green-400' : 'text-red-400'}">
                            ${t.side?.toUpperCase()} ${t.symbol}
                        </span>
                        <span class="text-xl font-bold ${pnl >= 0 ? 'positive' : 'negative'}">
                            ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-gray-800/50 p-2 rounded">
                            <div class="text-gray-400 text-xs">Entry</div>
                            <div class="font-medium">$${t.entryPrice?.toFixed(4) || '?'}</div>
                            <div class="text-xs text-gray-500">${entryTime.toLocaleString()}</div>
                        </div>
                        <div class="bg-gray-800/50 p-2 rounded">
                            <div class="text-gray-400 text-xs">Exit</div>
                            <div class="font-medium">$${t.exitPrice?.toFixed(4) || '?'}</div>
                            <div class="text-xs text-gray-500">${exitTime.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <div class="bg-gray-800/50 p-2 rounded text-center">
                            <div class="text-gray-400 text-xs">ROI</div>
                            <div class="${pnl >= 0 ? 'positive' : 'negative'}">${pnlPercent}%</div>
                        </div>
                        <div class="bg-gray-800/50 p-2 rounded text-center">
                            <div class="text-gray-400 text-xs">Duration</div>
                            <div>${duration < 60 ? duration.toFixed(0) + 'm' : (duration/60).toFixed(1) + 'h'}</div>
                        </div>
                        <div class="bg-gray-800/50 p-2 rounded text-center">
                            <div class="text-gray-400 text-xs">Size</div>
                            <div>${t.size || t.sizeUsd || '?'}</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-2 rounded">
                        <div class="text-gray-400 text-xs">Exit Reason</div>
                        <div class="font-medium">${exitReason}</div>
                    </div>
                    
                    <div class="bg-gray-800/50 p-2 rounded">
                        <div class="text-gray-400 text-xs">Strategy</div>
                        <div class="font-medium">${t.strategyId || 'Unknown'}</div>
                    </div>
                    
                    ${t.stopLoss || t.takeProfit ? `
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        ${t.stopLoss ? `<div class="bg-red-900/30 p-2 rounded">
                            <div class="text-red-400 text-xs">Stop Loss</div>
                            <div>$${t.stopLoss.toFixed(4)}</div>
                        </div>` : ''}
                        ${t.takeProfit ? `<div class="bg-green-900/30 p-2 rounded">
                            <div class="text-green-400 text-xs">Take Profit</div>
                            <div>$${t.takeProfit.toFixed(4)}</div>
                        </div>` : ''}
                    </div>
                    ` : ''}
                    
                    <button class="btn btn-primary w-full text-sm mt-2" onclick="focusTrade(${idx})">
                        üîç Focus on Chart
                    </button>
                </div>
            `;
            document.getElementById('trade-detail').innerHTML = html;
        }
        
        // Focus chart on specific trade
        function focusTrade(idx) {
            const t = allTrades[idx];
            if (!t || !mainChart) return;
            
            const entryTime = Math.floor(new Date(t.entryTimestamp || t.openTime).getTime() / 1000);
            const exitTime = Math.floor(new Date(t.exitTimestamp || t.closeTime).getTime() / 1000);
            
            // Add some padding (1 hour before and after)
            const padding = 3600;
            mainChart.timeScale().setVisibleRange({
                from: entryTime - padding,
                to: exitTime + padding,
            });
            
            // Clear existing price lines
            clearPriceLines();
            
            // Add entry price line
            if (t.entryPrice) {
                const entryLine = candleSeries.createPriceLine({
                    price: t.entryPrice,
                    color: t.side === 'long' ? '#22c55e' : '#ef4444',
                    lineWidth: 2,
                    lineStyle: 0, // Solid
                    axisLabelVisible: true,
                    title: 'Entry',
                });
                slLines.push(entryLine);
            }
            
            // Add exit price line
            if (t.exitPrice) {
                const exitLine = candleSeries.createPriceLine({
                    price: t.exitPrice,
                    color: '#3b82f6',
                    lineWidth: 2,
                    lineStyle: 0,
                    axisLabelVisible: true,
                    title: 'Exit',
                });
                tpLines.push(exitLine);
            }
            
            // Add SL line if available
            if (t.stopLoss) {
                const slLine = candleSeries.createPriceLine({
                    price: t.stopLoss,
                    color: '#ef4444',
                    lineWidth: 1,
                    lineStyle: 2, // Dashed
                    axisLabelVisible: true,
                    title: 'SL',
                });
                slLines.push(slLine);
            }
            
            // Add TP line if available
            if (t.takeProfit) {
                const tpLine = candleSeries.createPriceLine({
                    price: t.takeProfit,
                    color: '#22c55e',
                    lineWidth: 1,
                    lineStyle: 2, // Dashed
                    axisLabelVisible: true,
                    title: 'TP',
                });
                tpLines.push(tpLine);
            }
        }
        
        // Clear price lines
        function clearPriceLines() {
            slLines.forEach(line => {
                try { candleSeries.removePriceLine(line); } catch(e) {}
            });
            tpLines.forEach(line => {
                try { candleSeries.removePriceLine(line); } catch(e) {}
            });
            slLines = [];
            tpLines = [];
        }
        
        // Toggle indicators
        function toggleIndicator(indicator) {
            if (indicator === 'rsi') {
                const show = document.getElementById('show-rsi').checked;
                document.getElementById('rsi-container').classList.toggle('hidden', !show);
                if (show) {
                    loadChart(); // Reload to update RSI
                }
            } else if (indicator === 'ma') {
                const show = document.getElementById('show-ma').checked;
                if (ma20Series) ma20Series.applyOptions({ visible: show });
                if (ma50Series) ma50Series.applyOptions({ visible: show });
            } else if (indicator === 'volume') {
                const show = document.getElementById('show-volume').checked;
                if (volumeSeries) volumeSeries.applyOptions({ visible: show });
            }
        }
        
        // Toggle trades
        function toggleTrades() {
            const show = document.getElementById('show-trades').checked;
            if (show) {
                loadTradeMarkers(currentSymbol);
            } else {
                candleSeries.setMarkers([]);
            }
        }
        
        // Timeframe selection
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('bg-blue-600'));
                btn.classList.add('bg-blue-600');
                currentTimeframe = btn.dataset.tf;
                loadChart();
            });
        });
        
        // Override tab switching to init charts
        const originalShowTab = showTab;
        showTab = function(tab) {
            document.querySelectorAll('[id^="panel-"]').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            currentTab = tab;
            
            if (tab === 'charts') {
                setTimeout(() => loadChart(), 100);
            } else {
                refresh();
            }
        };
    </script>
</body>
</html>
