<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASH TOWN | Bloomberg Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --bg-primary: #0a0a12;
            --bg-secondary: #12121e;
            --bg-tertiary: #1a1a2e;
            --bg-hover: #252545;
            --border-color: #2a2a4a;
            --border-bright: #3a3a6a;
            --text-primary: #e8e8f0;
            --text-secondary: #9090b0;
            --text-muted: #606080;
            --accent-blue: #4a9eff;
            --accent-orange: #ff9500;
            --accent-purple: #a855f7;
            --green: #00ff88;
            --green-dim: #00cc6a;
            --red: #ff4757;
            --red-dim: #cc3a47;
            --yellow: #ffd93d;
            --cyan: #00d4ff;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.4;
            overflow: hidden;
            height: 100vh;
        }
        
        /* Bloomberg-style Header */
        .header {
            background: linear-gradient(180deg, #1e1e3a 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border-bright);
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 48px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-orange);
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(255, 149, 0, 0.3);
        }
        
        .logo span { color: var(--green); }
        
        .status-badges {
            display: flex;
            gap: 8px;
        }
        
        .badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-live { background: var(--red); color: white; animation: pulse 2s infinite; }
        .badge-paper { background: var(--accent-blue); color: white; }
        .badge-connected { background: var(--green-dim); color: white; }
        .badge-disconnected { background: var(--text-muted); color: white; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .header-center {
            display: flex;
            gap: 24px;
            font-size: 10px;
        }
        
        .header-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header-stat-label { color: var(--text-muted); font-size: 8px; }
        .header-stat-value { font-weight: 600; font-size: 12px; }
        .header-stat-value.positive { color: var(--green); }
        .header-stat-value.negative { color: var(--red); }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .clock {
            font-size: 14px;
            font-weight: 500;
            color: var(--accent-blue);
        }
        
        .btn {
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.15s;
        }
        
        .btn:hover { background: var(--bg-hover); border-color: var(--border-bright); }
        .btn-start { border-color: var(--green-dim); color: var(--green); }
        .btn-start:hover { background: rgba(0, 255, 136, 0.1); }
        .btn-stop { border-color: var(--red-dim); color: var(--red); }
        .btn-stop:hover { background: rgba(255, 71, 87, 0.1); }
        
        /* Main Layout */
        .main {
            display: grid;
            grid-template-columns: 1fr 1fr 300px;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            height: calc(100vh - 48px - 28px);
            padding: 2px;
            background: var(--border-color);
        }
        
        /* Panel Styling */
        .panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .panel-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-orange);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .panel-shortcut {
            font-size: 9px;
            color: var(--text-muted);
            padding: 2px 5px;
            background: var(--bg-primary);
            border-radius: 2px;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .panel-content::-webkit-scrollbar { width: 6px; }
        .panel-content::-webkit-scrollbar-track { background: var(--bg-primary); }
        .panel-content::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .panel-content::-webkit-scrollbar-thumb:hover { background: var(--border-bright); }
        
        /* Portfolio Overview Panel */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .metric-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
        }
        
        .metric-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .metric-value.positive { color: var(--green); }
        .metric-value.negative { color: var(--red); }
        .metric-value.neutral { color: var(--text-primary); }
        
        .metric-delta {
            font-size: 9px;
            margin-top: 2px;
        }
        
        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        
        .data-table th {
            text-align: left;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .data-table tr:hover { background: var(--bg-hover); cursor: pointer; }
        
        .data-table .positive { color: var(--green); }
        .data-table .negative { color: var(--red); }
        .data-table .muted { color: var(--text-muted); }
        
        .side-long { color: var(--green); font-weight: 600; }
        .side-short { color: var(--red); font-weight: 600; }
        
        /* Signal Feed */
        .signal-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 6px;
        }
        
        .signal-item.buy { border-left: 3px solid var(--green); }
        .signal-item.sell { border-left: 3px solid var(--red); }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .signal-symbol {
            font-weight: 600;
            color: var(--accent-blue);
        }
        
        .signal-confidence {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 2px;
            background: var(--bg-primary);
        }
        
        .signal-confidence.high { color: var(--green); border: 1px solid var(--green-dim); }
        .signal-confidence.medium { color: var(--yellow); border: 1px solid var(--yellow); }
        .signal-confidence.low { color: var(--red); border: 1px solid var(--red-dim); }
        
        .signal-details {
            font-size: 9px;
            color: var(--text-secondary);
        }
        
        .signal-strategy {
            font-size: 8px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Strategy Performance */
        .strategy-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .strategy-row:hover { background: var(--bg-hover); }
        
        .strategy-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .strategy-stats {
            display: flex;
            gap: 16px;
            font-size: 10px;
        }
        
        .strategy-stat-label {
            color: var(--text-muted);
            font-size: 8px;
        }
        
        /* Risk Metrics */
        .risk-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .risk-item {
            background: var(--bg-tertiary);
            border-radius: 4px;
            padding: 10px;
        }
        
        .risk-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        
        .risk-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .risk-bar-fill.safe { background: var(--green); }
        .risk-bar-fill.warning { background: var(--yellow); }
        .risk-bar-fill.danger { background: var(--red); }
        
        /* Chart Container */
        .chart-container {
            height: 140px;
            margin-top: 8px;
        }
        
        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-muted);
            height: 28px;
        }
        
        .status-left { display: flex; gap: 16px; }
        .status-right { display: flex; gap: 16px; }
        
        .status-item { display: flex; gap: 4px; align-items: center; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; }
        .status-dot.active { background: var(--green); animation: blink 1s infinite; }
        .status-dot.inactive { background: var(--red); }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-bright);
            border-radius: 8px;
            width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .modal-header {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title { font-weight: 600; color: var(--accent-orange); }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
        }
        
        .modal-close:hover { color: var(--red); }
        
        .modal-body { padding: 16px; overflow-y: auto; max-height: 60vh; }
        
        /* Keyboard shortcut hint */
        .shortcut-hint {
            position: fixed;
            bottom: 40px;
            right: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 9px;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .shortcut-hint.visible { opacity: 1; }
        
        .shortcut-hint kbd {
            background: var(--bg-primary);
            padding: 2px 5px;
            border-radius: 2px;
            margin-right: 4px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            font-size: 9px;
            font-family: inherit;
            border-radius: 3px;
        }
        
        .filter-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            font-size: 9px;
            font-family: inherit;
            border-radius: 3px;
            width: 100px;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
        }
        
        .empty-state-icon { font-size: 32px; margin-bottom: 8px; }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">CASH<span>TOWN</span></div>
            <div class="status-badges">
                <span class="badge badge-paper" id="mode-badge">PAPER</span>
                <span class="badge badge-disconnected" id="connection-badge">OFFLINE</span>
            </div>
        </div>
        <div class="header-center">
            <div class="header-stat">
                <span class="header-stat-label">EQUITY</span>
                <span class="header-stat-value" id="header-equity">$0.00</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">TODAY P&L</span>
                <span class="header-stat-value" id="header-daily-pnl">$0.00</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">TOTAL P&L</span>
                <span class="header-stat-value" id="header-total-pnl">$0.00</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">WIN RATE</span>
                <span class="header-stat-value" id="header-win-rate">0%</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">POSITIONS</span>
                <span class="header-stat-value neutral" id="header-positions">0</span>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-start" onclick="startTrading()" title="Start Trading">‚ñ∂ START</button>
            <button class="btn btn-stop" onclick="stopTrading()" title="Stop Trading">‚èπ STOP</button>
            <button class="btn" onclick="refreshAll()" title="Refresh Data">‚Üª</button>
            <span class="clock" id="clock">00:00:00</span>
        </div>
    </header>
    
    <!-- Main Grid -->
    <main class="main">
        <!-- Panel 1: Portfolio Overview -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üìä Portfolio Overview</span>
                <span class="panel-shortcut">F1</span>
            </div>
            <div class="panel-content">
                <div class="portfolio-grid">
                    <div class="metric-card">
                        <div class="metric-label">Account Balance</div>
                        <div class="metric-value neutral" id="account-balance">$0.00</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Unrealized P&L</div>
                        <div class="metric-value" id="unrealized-pnl">$0.00</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Realized P&L</div>
                        <div class="metric-value" id="realized-pnl">$0.00</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value neutral" id="total-trades">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value neutral" id="win-rate">0%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Exposure</div>
                        <div class="metric-value neutral" id="exposure">0%</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="equity-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Panel 2: Active Positions -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üìà Active Positions</span>
                <span class="panel-shortcut">F2</span>
            </div>
            <div class="panel-content">
                <table class="data-table" id="positions-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>Size</th>
                            <th>P&L</th>
                            <th>P&L %</th>
                        </tr>
                    </thead>
                    <tbody id="positions-body">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
                <div class="empty-state" id="positions-empty">
                    <div class="empty-state-icon">üì≠</div>
                    <div>No active positions</div>
                </div>
            </div>
        </div>
        
        <!-- Panel 3: Signal Feed (Right Column, spans both rows) -->
        <div class="panel" style="grid-row: span 2;">
            <div class="panel-header">
                <span class="panel-title">üì° Signal Feed</span>
                <span class="panel-shortcut">F5</span>
            </div>
            <div class="panel-content" id="signal-feed">
                <div class="empty-state" id="signals-empty">
                    <div class="empty-state-icon">üì°</div>
                    <div>Waiting for signals...</div>
                </div>
            </div>
        </div>
        
        <!-- Panel 4: Recent Trades -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üìú Recent Trades</span>
                <span class="panel-shortcut">F3</span>
            </div>
            <div class="panel-content">
                <div class="filters">
                    <select class="filter-select" id="trade-strategy-filter">
                        <option value="">All Strategies</option>
                    </select>
                    <select class="filter-select" id="trade-side-filter">
                        <option value="">All Sides</option>
                        <option value="buy">Long</option>
                        <option value="sell">Short</option>
                    </select>
                    <input type="text" class="filter-input" id="trade-symbol-filter" placeholder="Symbol...">
                </div>
                <table class="data-table" id="trades-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Strategy</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Panel 5: Strategy Performance + Risk -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üéØ Strategy & Risk</span>
                <span class="panel-shortcut">F4</span>
            </div>
            <div class="panel-content">
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Strategy Performance</div>
                    <div id="strategy-list">
                        <!-- Dynamic content -->
                    </div>
                </div>
                <div>
                    <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Risk Metrics</div>
                    <div class="risk-grid" id="risk-metrics">
                        <div class="risk-item">
                            <div class="metric-label">Max Drawdown</div>
                            <div class="metric-value negative" id="max-drawdown">0%</div>
                            <div class="risk-bar">
                                <div class="risk-bar-fill safe" id="drawdown-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="risk-item">
                            <div class="metric-label">Daily Loss</div>
                            <div class="metric-value" id="daily-loss">0%</div>
                            <div class="risk-bar">
                                <div class="risk-bar-fill safe" id="daily-loss-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="risk-item">
                            <div class="metric-label">Exposure</div>
                            <div class="metric-value neutral" id="current-exposure">0%</div>
                            <div class="risk-bar">
                                <div class="risk-bar-fill safe" id="exposure-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="risk-item">
                            <div class="metric-label">Circuit Breaker</div>
                            <div class="metric-value positive" id="circuit-status">ACTIVE</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Status Bar -->
    <footer class="status-bar">
        <div class="status-left">
            <div class="status-item">
                <span class="status-dot" id="ws-status"></span>
                <span>Data Feed</span>
            </div>
            <div class="status-item">
                <span>Last Update: <span id="last-update">--:--:--</span></span>
            </div>
            <div class="status-item">
                <span>Signals Today: <span id="signals-today">0</span></span>
            </div>
            <div class="status-item">
                <span>Trades Today: <span id="trades-today">0</span></span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-item">
                <span>Latency: <span id="latency">--ms</span></span>
            </div>
            <div class="status-item">
                <span>Press <kbd>?</kbd> for shortcuts</span>
            </div>
        </div>
    </footer>
    
    <!-- Shortcut Hint -->
    <div class="shortcut-hint" id="shortcut-hint">
        <div><kbd>F1</kbd> Portfolio <kbd>F2</kbd> Positions <kbd>F3</kbd> Trades <kbd>F4</kbd> Strategy</div>
        <div><kbd>F5</kbd> Signals <kbd>R</kbd> Refresh <kbd>ESC</kbd> Close Modal</div>
    </div>
    
    <!-- Trade Detail Modal -->
    <div class="modal-overlay" id="trade-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Trade Details</span>
                <button class="modal-close" onclick="closeModal('trade-modal')">&times;</button>
            </div>
            <div class="modal-body" id="trade-modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Strategy Detail Modal -->
    <div class="modal-overlay" id="strategy-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Strategy Performance</span>
                <button class="modal-close" onclick="closeModal('strategy-modal')">&times;</button>
            </div>
            <div class="modal-body" id="strategy-modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Position Detail Modal -->
    <div class="modal-overlay" id="position-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Position Details</span>
                <button class="modal-close" onclick="closeModal('position-modal')">&times;</button>
            </div>
            <div class="modal-body" id="position-modal-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <script>
        // ===== CONFIGURATION =====
        const API_BASE = 'https://web-production-63664b.up.railway.app';
        const CUCURBIT_API = 'https://autonomous-trading-cex-production.up.railway.app';
        const REFRESH_INTERVAL = 5000; // 5 seconds
        
        // ===== STATE =====
        let state = {
            connected: false,
            mode: 'paper',
            equity: 0,
            positions: [],
            trades: [],
            signals: [],
            strategies: {},
            risk: {},
            lastUpdate: null,
            equityHistory: []
        };
        
        let charts = {
            equity: null
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            startClock();
            startDataFeed();
            setupKeyboardShortcuts();
            setupFilters();
        });
        
        function initCharts() {
            const ctx = document.getElementById('equity-chart').getContext('2d');
            charts.equity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Equity',
                        data: [],
                        borderColor: '#4a9eff',
                        backgroundColor: 'rgba(74, 158, 255, 0.1)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: 'rgba(42, 42, 74, 0.5)' },
                            ticks: { color: '#606080', font: { size: 9 } }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(42, 42, 74, 0.5)' },
                            ticks: { color: '#606080', font: { size: 9 } }
                        }
                    }
                }
            });
        }
        
        function startClock() {
            function updateClock() {
                const now = new Date();
                document.getElementById('clock').textContent = 
                    now.toUTCString().split(' ')[4] + ' UTC';
            }
            updateClock();
            setInterval(updateClock, 1000);
        }
        
        // ===== DATA FEED =====
        function startDataFeed() {
            fetchAllData();
            setInterval(fetchAllData, REFRESH_INTERVAL);
        }
        
        async function fetchAllData() {
            const startTime = Date.now();
            
            try {
                // Fetch from Cash Town API
                const [health, signals, learning, risk, canTrade] = await Promise.all([
                    fetchWithTimeout(`${API_BASE}/health`),
                    fetchWithTimeout(`${API_BASE}/signals`),
                    fetchWithTimeout(`${API_BASE}/learning`),
                    fetchWithTimeout(`${API_BASE}/risk`),
                    fetchWithTimeout(`${API_BASE}/can_trade`)
                ]);
                
                // Fetch from Cucurbit API (for positions/trades)
                const [cucurbitStatus, cucurbitTrades] = await Promise.all([
                    fetchWithTimeout(`${CUCURBIT_API}/status`).catch(() => null),
                    fetchWithTimeout(`${CUCURBIT_API}/trades`).catch(() => null)
                ]);
                
                // Update state
                state.connected = true;
                state.signals = signals?.signals || [];
                state.strategies = learning?.strategies || {};
                state.risk = risk || {};
                state.canTrade = canTrade?.can_trade ?? true;
                state.canTradeReason = canTrade?.reason || '';
                
                if (cucurbitStatus) {
                    state.positions = cucurbitStatus.positions || [];
                    state.equity = cucurbitStatus.balance || 0;
                    state.mode = cucurbitStatus.mode || 'paper';
                    state.unrealizedPnl = state.positions.reduce((sum, p) => sum + (p.unrealized_pnl || 0), 0);
                }
                
                if (cucurbitTrades) {
                    state.trades = cucurbitTrades.trades || cucurbitTrades || [];
                }
                
                // Calculate totals from learning data
                let totalPnl = 0;
                let totalTrades = 0;
                let totalWins = 0;
                
                Object.values(state.strategies).forEach(s => {
                    totalPnl += s.total_pnl || 0;
                    totalTrades += s.total_trades || 0;
                    totalWins += s.wins || 0;
                });
                
                state.totalPnl = totalPnl;
                state.totalTrades = totalTrades;
                state.winRate = totalTrades > 0 ? (totalWins / totalTrades * 100) : 0;
                
                // Track equity history
                state.equityHistory.push({
                    time: new Date(),
                    equity: state.equity
                });
                if (state.equityHistory.length > 100) state.equityHistory.shift();
                
                state.lastUpdate = new Date();
                
                // Update UI
                updateUI();
                updateConnectionStatus(true);
                
                // Update latency
                const latency = Date.now() - startTime;
                document.getElementById('latency').textContent = `${latency}ms`;
                
            } catch (error) {
                console.error('Data fetch error:', error);
                updateConnectionStatus(false);
            }
        }
        
        async function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }
        
        // ===== UI UPDATES =====
        function updateUI() {
            updateHeader();
            updatePortfolio();
            updatePositions();
            updateTrades();
            updateSignals();
            updateStrategies();
            updateRisk();
            updateChart();
        }
        
        function updateHeader() {
            // Mode badge
            const modeBadge = document.getElementById('mode-badge');
            modeBadge.textContent = state.mode.toUpperCase();
            modeBadge.className = `badge badge-${state.mode === 'live' ? 'live' : 'paper'}`;
            
            // Stats
            document.getElementById('header-equity').textContent = formatCurrency(state.equity);
            
            const dailyPnl = calculateDailyPnl();
            updatePnlElement('header-daily-pnl', dailyPnl);
            updatePnlElement('header-total-pnl', state.totalPnl);
            
            const winRateEl = document.getElementById('header-win-rate');
            winRateEl.textContent = `${state.winRate.toFixed(1)}%`;
            winRateEl.className = `header-stat-value ${state.winRate >= 50 ? 'positive' : state.winRate > 0 ? 'neutral' : 'negative'}`;
            
            document.getElementById('header-positions').textContent = state.positions.length;
        }
        
        function updatePortfolio() {
            document.getElementById('account-balance').textContent = formatCurrency(state.equity);
            updatePnlElement('unrealized-pnl', state.unrealizedPnl || 0);
            updatePnlElement('realized-pnl', state.totalPnl);
            document.getElementById('total-trades').textContent = state.totalTrades;
            document.getElementById('win-rate').textContent = `${state.winRate.toFixed(1)}%`;
            
            const exposure = state.risk?.total_exposure_pct || 0;
            document.getElementById('exposure').textContent = `${exposure.toFixed(1)}%`;
        }
        
        function updatePositions() {
            const tbody = document.getElementById('positions-body');
            const empty = document.getElementById('positions-empty');
            
            if (!state.positions || state.positions.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            tbody.innerHTML = state.positions.map(p => `
                <tr onclick="showPositionDetail('${p.symbol}')">
                    <td style="color: var(--accent-blue); font-weight: 500;">${formatSymbol(p.symbol)}</td>
                    <td class="${p.is_long || p.side === 'long' ? 'side-long' : 'side-short'}">
                        ${p.is_long || p.side === 'long' ? 'LONG' : 'SHORT'}
                    </td>
                    <td>${formatPrice(p.entry_price || p.avgPrice)}</td>
                    <td>${formatPrice(p.current_price || p.markPrice)}</td>
                    <td>${formatNumber(Math.abs(p.size || p.qty))}</td>
                    <td class="${(p.unrealized_pnl || p.unrealizedPnl || 0) >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(p.unrealized_pnl || p.unrealizedPnl || 0)}
                    </td>
                    <td class="${(p.pnl_pct || p.unrealizedPnlPct || 0) >= 0 ? 'positive' : 'negative'}">
                        ${(p.pnl_pct || p.unrealizedPnlPct || 0).toFixed(2)}%
                    </td>
                </tr>
            `).join('');
        }
        
        function updateTrades() {
            const tbody = document.getElementById('trades-body');
            const strategyFilter = document.getElementById('trade-strategy-filter').value;
            const sideFilter = document.getElementById('trade-side-filter').value;
            const symbolFilter = document.getElementById('trade-symbol-filter').value.toUpperCase();
            
            let trades = state.trades || [];
            
            // Apply filters
            if (strategyFilter) trades = trades.filter(t => t.strategy_id === strategyFilter);
            if (sideFilter) trades = trades.filter(t => t.side === sideFilter);
            if (symbolFilter) trades = trades.filter(t => t.symbol.includes(symbolFilter));
            
            // Sort by time, most recent first
            trades = trades.sort((a, b) => new Date(b.timestamp || b.time) - new Date(a.timestamp || a.time));
            
            // Take last 50
            trades = trades.slice(0, 50);
            
            tbody.innerHTML = trades.map(t => `
                <tr onclick="showTradeDetail('${t.id || t.trade_id}')">
                    <td class="muted">${formatTime(t.timestamp || t.time)}</td>
                    <td style="color: var(--accent-blue);">${formatSymbol(t.symbol)}</td>
                    <td class="${t.side === 'buy' || t.side === 'long' ? 'side-long' : 'side-short'}">
                        ${(t.side || '').toUpperCase()}
                    </td>
                    <td class="muted">${t.strategy_id || t.strategy || '-'}</td>
                    <td>${formatPrice(t.entry_price || t.price)}</td>
                    <td>${formatPrice(t.exit_price || '-')}</td>
                    <td class="${(t.pnl || 0) >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(t.pnl || 0)}
                    </td>
                </tr>
            `).join('');
            
            // Update strategy filter options
            updateStrategyFilterOptions();
            
            // Update today's trades count
            const today = new Date().toDateString();
            const todayTrades = (state.trades || []).filter(t => 
                new Date(t.timestamp || t.time).toDateString() === today
            ).length;
            document.getElementById('trades-today').textContent = todayTrades;
        }
        
        function updateSignals() {
            const feed = document.getElementById('signal-feed');
            const empty = document.getElementById('signals-empty');
            
            if (!state.signals || state.signals.length === 0) {
                feed.innerHTML = '';
                feed.appendChild(empty);
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            feed.innerHTML = state.signals.map(s => {
                const confidenceClass = s.confidence >= 0.7 ? 'high' : s.confidence >= 0.5 ? 'medium' : 'low';
                const sideClass = s.side === 'buy' || s.side === 'long' ? 'buy' : 'sell';
                
                return `
                    <div class="signal-item ${sideClass}">
                        <div class="signal-header">
                            <span class="signal-symbol">${formatSymbol(s.symbol)}</span>
                            <span class="signal-confidence ${confidenceClass}">
                                ${(s.confidence * 100).toFixed(0)}%
                            </span>
                        </div>
                        <div class="signal-details">
                            <span class="${sideClass === 'buy' ? 'side-long' : 'side-short'}">${s.side.toUpperCase()}</span>
                            @ ${formatPrice(s.price)}
                            ${s.stop_loss ? `‚Ä¢ SL: ${formatPrice(s.stop_loss)}` : ''}
                            ${s.take_profit ? `‚Ä¢ TP: ${formatPrice(s.take_profit)}` : ''}
                        </div>
                        <div class="signal-strategy">
                            ${s.strategy_id || s.sources?.join(', ') || 'Unknown'} 
                            ${s.rank ? `‚Ä¢ Rank #${s.rank}` : ''}
                            ${s.consensus ? `‚Ä¢ Consensus: ${(s.consensus * 100).toFixed(0)}%` : ''}
                        </div>
                        ${s.reason ? `<div class="signal-strategy" style="color: var(--text-secondary); margin-top: 4px;">${s.reason}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Update signals today count
            document.getElementById('signals-today').textContent = state.signals.length;
        }
        
        function updateStrategies() {
            const container = document.getElementById('strategy-list');
            const strategies = Object.entries(state.strategies);
            
            if (strategies.length === 0) {
                container.innerHTML = '<div class="empty-state"><div>No strategy data</div></div>';
                return;
            }
            
            // Sort by total PnL
            strategies.sort((a, b) => (b[1].total_pnl || 0) - (a[1].total_pnl || 0));
            
            container.innerHTML = strategies.map(([id, s]) => {
                const winRate = s.total_trades > 0 ? (s.wins / s.total_trades * 100) : 0;
                const pnlClass = (s.total_pnl || 0) >= 0 ? 'positive' : 'negative';
                
                return `
                    <div class="strategy-row" onclick="showStrategyDetail('${id}')">
                        <div class="strategy-name">${formatStrategyName(id)}</div>
                        <div class="strategy-stats">
                            <div>
                                <div class="strategy-stat-label">P&L</div>
                                <div class="${pnlClass}">${formatCurrency(s.total_pnl || 0)}</div>
                            </div>
                            <div>
                                <div class="strategy-stat-label">TRADES</div>
                                <div>${s.total_trades || 0}</div>
                            </div>
                            <div>
                                <div class="strategy-stat-label">WIN%</div>
                                <div class="${winRate >= 50 ? 'positive' : 'neutral'}">${winRate.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRisk() {
            const risk = state.risk || {};
            
            // Max drawdown
            const drawdown = Math.abs(risk.max_drawdown_pct || 0);
            document.getElementById('max-drawdown').textContent = `${drawdown.toFixed(2)}%`;
            updateRiskBar('drawdown-bar', drawdown, 10); // 10% is danger threshold
            
            // Daily loss
            const dailyLoss = Math.abs(risk.daily_loss_pct || 0);
            document.getElementById('daily-loss').textContent = `${dailyLoss.toFixed(2)}%`;
            document.getElementById('daily-loss').className = `metric-value ${dailyLoss > 2 ? 'negative' : 'neutral'}`;
            updateRiskBar('daily-loss-bar', dailyLoss, 3); // 3% is danger threshold
            
            // Exposure
            const exposure = risk.total_exposure_pct || 0;
            document.getElementById('current-exposure').textContent = `${exposure.toFixed(1)}%`;
            updateRiskBar('exposure-bar', exposure, 30); // 30% is max exposure
            
            // Circuit breaker
            const circuitEl = document.getElementById('circuit-status');
            if (state.canTrade) {
                circuitEl.textContent = 'ACTIVE';
                circuitEl.className = 'metric-value positive';
            } else {
                circuitEl.textContent = 'TRIPPED';
                circuitEl.className = 'metric-value negative';
            }
        }
        
        function updateRiskBar(barId, value, threshold) {
            const bar = document.getElementById(barId);
            const percentage = Math.min((value / threshold) * 100, 100);
            bar.style.width = `${percentage}%`;
            
            if (percentage >= 80) {
                bar.className = 'risk-bar-fill danger';
            } else if (percentage >= 50) {
                bar.className = 'risk-bar-fill warning';
            } else {
                bar.className = 'risk-bar-fill safe';
            }
        }
        
        function updateChart() {
            if (state.equityHistory.length < 2) return;
            
            charts.equity.data.labels = state.equityHistory.map(h => 
                h.time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            );
            charts.equity.data.datasets[0].data = state.equityHistory.map(h => h.equity);
            charts.equity.update('none');
        }
        
        function updateConnectionStatus(connected) {
            state.connected = connected;
            const badge = document.getElementById('connection-badge');
            const dot = document.getElementById('ws-status');
            
            if (connected) {
                badge.textContent = 'LIVE';
                badge.className = 'badge badge-connected';
                dot.className = 'status-dot active';
                document.getElementById('last-update').textContent = 
                    new Date().toLocaleTimeString();
            } else {
                badge.textContent = 'OFFLINE';
                badge.className = 'badge badge-disconnected';
                dot.className = 'status-dot inactive';
            }
        }
        
        // ===== HELPERS =====
        function formatCurrency(value) {
            if (value === undefined || value === null) return '$0.00';
            const sign = value >= 0 ? '' : '-';
            return `${sign}$${Math.abs(value).toFixed(2)}`;
        }
        
        function formatPrice(value) {
            if (!value || value === '-') return '-';
            if (value >= 1000) return value.toFixed(2);
            if (value >= 1) return value.toFixed(4);
            return value.toFixed(6);
        }
        
        function formatNumber(value) {
            if (value === undefined || value === null) return '0';
            return value.toLocaleString(undefined, { maximumFractionDigits: 4 });
        }
        
        function formatSymbol(symbol) {
            return symbol.replace('USDTM', '').replace('USDT', '');
        }
        
        function formatStrategyName(id) {
            return id.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function updatePnlElement(id, value) {
            const el = document.getElementById(id);
            el.textContent = formatCurrency(value);
            el.className = el.className.replace(/positive|negative|neutral/g, '').trim();
            el.classList.add(value >= 0 ? 'positive' : 'negative');
        }
        
        function calculateDailyPnl() {
            const today = new Date().toDateString();
            return (state.trades || [])
                .filter(t => new Date(t.timestamp || t.time).toDateString() === today)
                .reduce((sum, t) => sum + (t.pnl || 0), 0);
        }
        
        function updateStrategyFilterOptions() {
            const select = document.getElementById('trade-strategy-filter');
            const current = select.value;
            const strategies = [...new Set((state.trades || []).map(t => t.strategy_id || t.strategy).filter(Boolean))];
            
            select.innerHTML = '<option value="">All Strategies</option>' +
                strategies.map(s => `<option value="${s}" ${s === current ? 'selected' : ''}>${formatStrategyName(s)}</option>`).join('');
        }
        
        // ===== MODALS =====
        function showTradeDetail(tradeId) {
            const trade = state.trades.find(t => (t.id || t.trade_id) === tradeId);
            if (!trade) return;
            
            const body = document.getElementById('trade-modal-body');
            body.innerHTML = `
                <div class="portfolio-grid">
                    <div class="metric-card">
                        <div class="metric-label">Symbol</div>
                        <div class="metric-value neutral">${formatSymbol(trade.symbol)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Side</div>
                        <div class="metric-value ${trade.side === 'buy' ? 'positive' : 'negative'}">${(trade.side || '').toUpperCase()}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">P&L</div>
                        <div class="metric-value ${(trade.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(trade.pnl || 0)}</div>
                    </div>
                </div>
                <table class="data-table" style="margin-top: 16px;">
                    <tr><td class="muted">Strategy</td><td>${formatStrategyName(trade.strategy_id || trade.strategy || '-')}</td></tr>
                    <tr><td class="muted">Entry Price</td><td>${formatPrice(trade.entry_price || trade.price)}</td></tr>
                    <tr><td class="muted">Exit Price</td><td>${formatPrice(trade.exit_price || '-')}</td></tr>
                    <tr><td class="muted">Size</td><td>${formatNumber(trade.size || trade.qty)}</td></tr>
                    <tr><td class="muted">P&L %</td><td class="${(trade.pnl_pct || 0) >= 0 ? 'positive' : 'negative'}">${(trade.pnl_pct || 0).toFixed(2)}%</td></tr>
                    <tr><td class="muted">Time</td><td>${new Date(trade.timestamp || trade.time).toLocaleString()}</td></tr>
                    <tr><td class="muted">Reason</td><td>${trade.reason || '-'}</td></tr>
                </table>
            `;
            
            openModal('trade-modal');
        }
        
        function showStrategyDetail(strategyId) {
            const strategy = state.strategies[strategyId];
            if (!strategy) return;
            
            const winRate = strategy.total_trades > 0 ? (strategy.wins / strategy.total_trades * 100) : 0;
            const avgWin = strategy.wins > 0 ? (strategy.total_win_pnl || 0) / strategy.wins : 0;
            const avgLoss = strategy.losses > 0 ? Math.abs(strategy.total_loss_pnl || 0) / strategy.losses : 0;
            const profitFactor = avgLoss > 0 ? avgWin / avgLoss : 0;
            
            const body = document.getElementById('strategy-modal-body');
            body.innerHTML = `
                <div class="portfolio-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total P&L</div>
                        <div class="metric-value ${(strategy.total_pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(strategy.total_pnl || 0)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value ${winRate >= 50 ? 'positive' : 'neutral'}">${winRate.toFixed(1)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Profit Factor</div>
                        <div class="metric-value ${profitFactor >= 1 ? 'positive' : 'negative'}">${profitFactor.toFixed(2)}</div>
                    </div>
                </div>
                <table class="data-table" style="margin-top: 16px;">
                    <tr><td class="muted">Total Trades</td><td>${strategy.total_trades || 0}</td></tr>
                    <tr><td class="muted">Wins</td><td class="positive">${strategy.wins || 0}</td></tr>
                    <tr><td class="muted">Losses</td><td class="negative">${strategy.losses || 0}</td></tr>
                    <tr><td class="muted">Avg Win</td><td class="positive">${formatCurrency(avgWin)}</td></tr>
                    <tr><td class="muted">Avg Loss</td><td class="negative">${formatCurrency(-avgLoss)}</td></tr>
                    <tr><td class="muted">Best Trade</td><td class="positive">${formatCurrency(strategy.best_trade || 0)}</td></tr>
                    <tr><td class="muted">Worst Trade</td><td class="negative">${formatCurrency(strategy.worst_trade || 0)}</td></tr>
                    <tr><td class="muted">Confidence Boost</td><td>${((strategy.confidence_multiplier || 1) * 100 - 100).toFixed(0)}%</td></tr>
                </table>
            `;
            
            openModal('strategy-modal');
        }
        
        function showPositionDetail(symbol) {
            const position = state.positions.find(p => p.symbol === symbol);
            if (!position) return;
            
            const body = document.getElementById('position-modal-body');
            body.innerHTML = `
                <div class="portfolio-grid">
                    <div class="metric-card">
                        <div class="metric-label">Symbol</div>
                        <div class="metric-value neutral">${formatSymbol(position.symbol)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Side</div>
                        <div class="metric-value ${position.is_long || position.side === 'long' ? 'positive' : 'negative'}">
                            ${position.is_long || position.side === 'long' ? 'LONG' : 'SHORT'}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Unrealized P&L</div>
                        <div class="metric-value ${(position.unrealized_pnl || 0) >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(position.unrealized_pnl || position.unrealizedPnl || 0)}
                        </div>
                    </div>
                </div>
                <table class="data-table" style="margin-top: 16px;">
                    <tr><td class="muted">Entry Price</td><td>${formatPrice(position.entry_price || position.avgPrice)}</td></tr>
                    <tr><td class="muted">Current Price</td><td>${formatPrice(position.current_price || position.markPrice)}</td></tr>
                    <tr><td class="muted">Size</td><td>${formatNumber(Math.abs(position.size || position.qty))}</td></tr>
                    <tr><td class="muted">Notional Value</td><td>${formatCurrency(position.notional || 0)}</td></tr>
                    <tr><td class="muted">Leverage</td><td>${position.leverage || 1}x</td></tr>
                    <tr><td class="muted">Liquidation Price</td><td>${formatPrice(position.liq_price || '-')}</td></tr>
                    <tr><td class="muted">Strategy</td><td>${formatStrategyName(position.strategy_id || '-')}</td></tr>
                </table>
                <div style="margin-top: 16px;">
                    <button class="btn btn-stop" onclick="closePosition('${symbol}')" style="width: 100%;">
                        Close Position
                    </button>
                </div>
            `;
            
            openModal('position-modal');
        }
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // ===== ACTIONS =====
        async function startTrading() {
            alert('Start trading command sent');
            // TODO: Implement actual start command
        }
        
        async function stopTrading() {
            alert('Stop trading command sent');
            // TODO: Implement actual stop command
        }
        
        async function closePosition(symbol) {
            if (!confirm(`Close position for ${formatSymbol(symbol)}?`)) return;
            
            try {
                const response = await fetch(`${CUCURBIT_API}/close`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                
                if (response.ok) {
                    closeModal('position-modal');
                    fetchAllData();
                } else {
                    alert('Failed to close position');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function refreshAll() {
            await fetchAllData();
        }
        
        // ===== KEYBOARD SHORTCUTS =====
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Close modals on Escape
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(m => 
                        m.classList.remove('active')
                    );
                    return;
                }
                
                // Refresh on R
                if (e.key === 'r' || e.key === 'R') {
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        refreshAll();
                    }
                    return;
                }
                
                // Show shortcuts on ?
                if (e.key === '?') {
                    const hint = document.getElementById('shortcut-hint');
                    hint.classList.toggle('visible');
                    setTimeout(() => hint.classList.remove('visible'), 3000);
                    return;
                }
                
                // Function keys for panel focus (F1-F5)
                if (e.key >= 'F1' && e.key <= 'F5') {
                    e.preventDefault();
                    const panels = document.querySelectorAll('.panel');
                    const index = parseInt(e.key.slice(1)) - 1;
                    if (panels[index]) {
                        panels[index].scrollIntoView({ behavior: 'smooth' });
                        panels[index].querySelector('.panel-content')?.focus();
                    }
                }
            });
        }
        
        // ===== FILTERS =====
        function setupFilters() {
            ['trade-strategy-filter', 'trade-side-filter', 'trade-symbol-filter'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateTrades);
                document.getElementById(id).addEventListener('input', updateTrades);
            });
        }
    </script>
</body>
</html>
